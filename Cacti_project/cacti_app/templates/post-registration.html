{% extends 'default.html' %}

{% block body %}

<div class="section no-pad-bot" id="index-banner">
    <div class="container" id="form">
        <br>
        <h1 class="header center orange-text">Cacti</h1>
        <div class="row center">
            <h5 class="header col s12 light">Add a time frame when you're not free. We'll keep track of this.</h5>
        </div>
        {% include "schedule_form.html" %}
    </div>
</div>

<!-- Jquery imports -->
{% include "scripts.html" %}
<script type="text/javascript" src="/static/js/datecheck.js"></script>
<script type="text/javascript" src="/static/js/constructJSON.js"></script>
<!-- Initialization -->
<script>
	$(document).ready(function () {
		$('select').material_select();

        var count = 0;

        var serializationList = []; // Stores all forms serialized.
        var formStack = []; // Stores the latest ID when a block is added.

        // Grab the csrfmiddlewaretoken
        var csrfToken = $('form:first')[0][0]['value'];
        console.log(csrfToken);

        $('#add').click(function (e) {
            // Get the first instance of the form in the DOM
            var source = $('form:first');
            var clone = source.clone();

            // The following for loops below will simply search the duplicated
            // form and change the IDS, Names, and Labels tags.
            clone.find(':input').attr('id', function(i, val) {
                return val + count;
            });

            clone.find(':input').attr('name', function (i, val) {
                return val + count;
            });

            clone.find('label').attr('for', function (i, val) {
                return val + count;
            });

            console.log(clone.find('form').attr('id', function (i, val) {
                return val + count;
            }));

            clone.attr('id', function (i, val) {
                return val + count;
            });

            // Push the duplicated form's ID into the stack.
            formStack.push(clone.attr('id'));

            // Move the cloned form to the end of the page.
            clone.appendTo('#form-section');
            // Move the buttons to the end of the form.
            $('#button-section').appendTo('#form-section');

            count++;
            e.preventDefault();
        });

        $('#remove').click(function (e) {
            // TODO: Get the latest id and remove that element via Jquery.
            // TODO: Pop the last element of the stack.
            $(formStack.pop()).remove();
            // Decrement the counter
            count--;
        });

        $('#ajax-test').click(function (e) {
            // Get all forms currently in the DOM.
            var forms = document.getElementsByTagName('form');

            // For each form in the list, construct JSON objects and append them to a list.
            for (var i = 0; i < forms.length; i++) {
                var jsonObject = makeJSON(forms[i][0]['defaultValue'], forms[i][1]['value'], forms[i][2]['value'], forms[i][3]['value'], forms[i][4]['value']);
                serializationList.push(jsonObject);
            }

            // TODO: Check if the times conflict.
            for (var i = 0; i < serializationList.length; i++) {
                if (!areDatesCorrect(serializationList[i]['start_time'], serializationList[i]['end_time'])) {
                    // If there are time conflicts, then stop the default action (submit)
                    e.preventDefault();
                }
            }

            $.ajax({
                type: "POST",
                url: "/cacti_app/process-schedule",
                data: {
                    'csrfmiddlewaretoken': csrfToken,
                    // Make the JSON object into a human readable string.
                    // TODO: Make sure the view function associated with process-schedule loads the JSON.
                    'json_data': JSON.stringify(serializationList),
                    'length': count
                },
                success: function (data) {
                    console.log(data);
                },
                error : function (err) {
                    console.log(err);
                },
                datatype: "json"
            });
        });
    });
</script>

{% endblock %}
